<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iOS Safari Video Compatibility Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>iOS Safari Video Compatibility Test</h1>
    
    <div class="test-section">
        <h2>1. Device Detection</h2>
        <div id="device-detection"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Video Format Support</h2>
        <div id="format-support"></div>
    </div>
    
    <div class="test-section">
        <h2>3. HLS Support</h2>
        <div id="hls-support"></div>
    </div>
    
    <div class="test-section">
        <h2>4. MediaRecorder Support</h2>
        <div id="mediarecorder-support"></div>
    </div>
    
    <div class="test-section">
        <h2>5. Video Playback Test</h2>
        <video id="test-video" controls preload="metadata">
            <source src="/api/video/file/sample.mp4" type="video/mp4; codecs=&quot;avc1.42E01E, mp4a.40.2&quot;">
            <source src="/api/video/file/sample.mp4" type="video/mp4">
            <source src="/api/video/file/sample.webm" type="video/webm">
            Your browser does not support video playback.
        </video>
        <br>
        <button onclick="testVideoPlayback()">Test Playback</button>
        <div id="playback-results"></div>
    </div>

    <script>
        // iOS Safari detection
        function isIOSSafari() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isIOS = /ipad|iphone|ipod/.test(userAgent);
            const isSafari = /safari/.test(userAgent) && !/chrome|crios|fxios/.test(userAgent);
            return isIOS && isSafari;
        }

        // Check HLS support
        function supportsHLS() {
            const video = document.createElement('video');
            return video.canPlayType('application/vnd.apple.mpegurl') !== '';
        }

        // Check MSE support
        function supportsMSE() {
            return typeof MediaSource !== 'undefined';
        }

        // Test device detection
        function testDeviceDetection() {
            const isIOS = isIOSSafari();
            const userAgent = navigator.userAgent;
            
            document.getElementById('device-detection').innerHTML = `
                <div class="info">User Agent: ${userAgent}</div>
                <div class="${isIOS ? 'pass' : 'info'}">
                    iOS Safari Detected: ${isIOS ? 'YES' : 'NO'}
                </div>
                <div class="info">Platform: ${navigator.platform}</div>
            `;
        }

        // Test format support
        function testFormatSupport() {
            const video = document.createElement('video');
            const formats = [
                { name: 'MP4 H.264', type: 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"' },
                { name: 'MP4 Basic', type: 'video/mp4' },
                { name: 'WebM VP8', type: 'video/webm; codecs="vp8, vorbis"' },
                { name: 'WebM VP9', type: 'video/webm; codecs="vp9, opus"' },
                { name: 'WebM Basic', type: 'video/webm' }
            ];
            
            let html = '';
            formats.forEach(format => {
                const support = video.canPlayType(format.type);
                const status = support === 'probably' ? 'pass' : support === 'maybe' ? 'info' : 'fail';
                html += `<div class="${status}">${format.name}: ${support || 'not supported'}</div>`;
            });
            
            document.getElementById('format-support').innerHTML = html;
        }

        // Test HLS support
        function testHLSSupport() {
            const hlsSupport = supportsHLS();
            const mseSupport = supportsMSE();
            
            document.getElementById('hls-support').innerHTML = `
                <div class="${hlsSupport ? 'pass' : 'fail'}">Native HLS Support: ${hlsSupport ? 'YES' : 'NO'}</div>
                <div class="${mseSupport ? 'pass' : 'fail'}">Media Source Extensions: ${mseSupport ? 'YES' : 'NO'}</div>
            `;
        }

        // Test MediaRecorder support
        function testMediaRecorderSupport() {
            const hasMediaRecorder = typeof MediaRecorder !== 'undefined';
            let html = `<div class="${hasMediaRecorder ? 'pass' : 'fail'}">MediaRecorder Available: ${hasMediaRecorder ? 'YES' : 'NO'}</div>`;
            
            if (hasMediaRecorder) {
                const formats = [
                    'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',
                    'video/mp4',
                    'video/webm; codecs="vp8, opus"',
                    'video/webm; codecs="vp9, opus"',
                    'video/webm'
                ];
                
                formats.forEach(format => {
                    const supported = MediaRecorder.isTypeSupported(format);
                    html += `<div class="${supported ? 'pass' : 'fail'}">${format}: ${supported ? 'SUPPORTED' : 'NOT SUPPORTED'}</div>`;
                });
            }
            
            document.getElementById('mediarecorder-support').innerHTML = html;
        }

        // Test video playback
        function testVideoPlayback() {
            const video = document.getElementById('test-video');
            const results = document.getElementById('playback-results');
            
            results.innerHTML = '<div class="info">Testing video playback...</div>';
            
            video.addEventListener('loadedmetadata', function() {
                results.innerHTML += '<div class="pass">✅ Video metadata loaded successfully</div>';
            }, { once: true });
            
            video.addEventListener('canplay', function() {
                results.innerHTML += '<div class="pass">✅ Video can start playing</div>';
            }, { once: true });
            
            video.addEventListener('error', function(e) {
                const error = video.error;
                results.innerHTML += `<div class="fail">❌ Video error: ${error ? error.message : 'Unknown error'}</div>`;
            });
            
            // Try to play
            video.play().then(() => {
                results.innerHTML += '<div class="pass">✅ Video playback started successfully</div>';
                setTimeout(() => {
                    video.pause();
                    results.innerHTML += '<div class="info">ℹ️ Video paused for testing</div>';
                }, 2000);
            }).catch(e => {
                results.innerHTML += `<div class="fail">❌ Play failed: ${e.message}</div>`;
                if (isIOSSafari()) {
                    results.innerHTML += '<div class="info">ℹ️ This is normal on iOS Safari - user interaction required</div>';
                }
            });
        }

        // Run tests on page load
        document.addEventListener('DOMContentLoaded', function() {
            testDeviceDetection();
            testFormatSupport();
            testHLSSupport();
            testMediaRecorderSupport();
        });
    </script>
</body>
</html>